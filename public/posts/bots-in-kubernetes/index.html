<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bots in Kubernetes | Blowfish</title>
  <meta name="description" content="Personal website and blog">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <header>
    <nav>
      <ul>
        
        <li><a href="/about/">About</a></li>
        
        <li><a href="/posts/">Blog</a></li>
        
        <li><a href="/tags/">Tags</a></li>
        
        <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </nav>
  </header>
  
  <main>
    
<article>
  <h1>Bots in Kubernetes</h1>
  <p>Published on August 2, 2018</p>
  
  
<h1 class="relative group">Bots in Kube 
    <div id="bots-in-kube" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#bots-in-kube" aria-label="Anchor">#</a>
    </span>        
    
</h1>
<p>So you&rsquo;ve built for first bot with Microsoft <a
  href="https://docs.microsoft.com/en-us/azure/bot-service/nodejs/bot-builder-nodejs-quickstart?view=azure-bot-service-3.0"
    target="_blank"
  >BotBuilder SDK</a>, deployed it to <a
  href="https://azure.microsoft.com/en-au/services/app-service/"
    target="_blank"
  >Azure App Service</a> or <a
  href="https://cloud.google.com/appengine/"
    target="_blank"
  >GCloud App Engine</a>, and everything is just swell. Then along comes your company&rsquo;s CTO, who says they&rsquo;ve committed to all their services having zero downtime (best effort of course). On the same day, your friend had the great idea to start doing A/B testing. What do you do?</p>
<p>You&rsquo;ve outgrown the App Service platform. Hello Kubernetes.</p>

<h2 class="relative group">What to do 
    <div id="what-to-do" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#what-to-do" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>There&rsquo;s three things we have to do to get our bot into k8s.</p>
<ol>
<li>Containerise the bot code</li>
<li>Provision a Kubernetes Cluster</li>
<li>Enable cluster HTTPS Ingress</li>
</ol>

<h2 class="relative group">Containerising a Bot 
    <div id="containerising-a-bot" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#containerising-a-bot" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Lucky for us, bots look mostly like web servers, and we&rsquo;re pretty good at containerising web servers. Create a <code>Dockerfile</code> that builds your bot image. It should look something like this one, which uses the <a
  href="https://docs.docker.com/develop/develop-images/multistage-build/"
    target="_blank"
  >builder pattern</a> to reduce the size of the output image.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-docker" data-lang="docker"><span class="line"><span class="cl"><span class="c"># this file builds a bot built in Typescript.</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> ubuntu:16.04 as builder</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    apt-get install -y curl <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    curl -sL https://deb.nodesource.com/setup_10.x <span class="p">|</span> bash <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    apt-get install -y git nodejs build-essential<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> npm install -g node-gyp <span class="o">&amp;&amp;</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>    npm install -g typescript<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /build</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> my-bot/package.json .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> npm install <span class="c1"># this helps reduce build times during dev iteration</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> my-bot .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> npm run build<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> node:10-alpine</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">WORKDIR</span><span class="s"> /app/</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> --from<span class="o">=</span>builder /build .<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENTRYPOINT</span> <span class="p">[</span> <span class="s2">&#34;node&#34;</span><span class="p">,</span> <span class="s2">&#34;js/app.js&#34;</span> <span class="p">]</span><span class="err">
</span></span></span></code></pre></div><p>Running the container locally and connecting with the <a
  href="https://github.com/Microsoft/BotFramework-Emulator"
    target="_blank"
  >Bot Framework Emulator</a>, you might see this error</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">BotFrameworkAdapter.processActivity(): 500 ERROR - FetchError: request to http://localhost:60321/v3/conversations/1dk6m0la5ji6/activities/bcmfna2mfjmf failed, reason: connect ECONNREFUSED 127.0.0.1:60321
</span></span></code></pre></div><p>That&rsquo;s because the Emulator opens a localhost port to listen for messages from the bot, but that address is not actually accessible from inside the container, hence the connection refused. You need to disable &lsquo;Bypass ngrok for local addresses&rsquo;.</p>
<p>






<figure>
    <img class="my-0 rounded-md" loading="lazy" alt="Screenshot of bypass ngrok on localhost setting disabled" src="/images/botsinkube/bypass-ngrok.png">

  
</figure>
</p>

<h3 class="relative group">Publish the image 
    <div id="publish-the-image" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#publish-the-image" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Once you&rsquo;ve built the image, publish it to the repository of your choice, e.g. <a
  href="https://hub.docker.com/"
    target="_blank"
  >Docker Hub</a>. Now it&rsquo;s ready to be deployed into the cluster.</p>

<h2 class="relative group">Provision a Kubernetes Cluster 
    <div id="provision-a-kubernetes-cluster" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#provision-a-kubernetes-cluster" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>Now creating a kubernetes cluster from scratch is hard. If your like me, you&rsquo;d prefer if someone else did the hard work for you. Well they have!</p>
<p><a
  href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough"
    target="_blank"
  >Azure Kubernetes Service (AKS)</a> is the fasted way to get a cluster up and running. Just spin it up via Azure CLI. Then run this command - <code>az aks get-credentials</code> - and kubectl now interacts with the cluster. Almost too easy.</p>
<blockquote>
<p>Side note: It&rsquo;s important to have a stateless bot (i.e. state remains in a remote database like CosmosDB and not memory) because Kubernetes deployments work best this way.</p></blockquote>

<h3 class="relative group">Deploy the bot 
    <div id="deploy-the-bot" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#deploy-the-bot" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Your bot will need three kubernetes objects: a <code>deployment</code>, a <code>service</code>, and a <code>secret</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">dockerhubrepo/my-bot:tag</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">PORT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;80&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MICROSOFT_APP_ID</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">microsoft-bot-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app-id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">MICROSOFT_APP_PASSWORD</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">microsoft-bot-app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app-password</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nn">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>Create the secret:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> /your/secrets/directory
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;your-id&#39;</span> &gt; ./app-id
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s1">&#39;your-password&#39;</span> &gt; ./app-password
</span></span><span class="line"><span class="cl">kubectl create secret generic microsoft-bot-app --from-file<span class="o">=</span>./app-password --from-file<span class="o">=</span>./app-id
</span></span></code></pre></div>
<h2 class="relative group">Enable Cluster HTTPS Ingress 
    <div id="enable-cluster-https-ingress" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#enable-cluster-https-ingress" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>This step is probably the most convoluted, but once you&rsquo;re up and running, it should require much intervention. I&rsquo;m not going to rewrite all the steps (there are many) but follow <a
  href="https://docs.microsoft.com/en-us/azure/aks/ingress"
    target="_blank"
  >this walkthrough</a> for enabling HTTPS ingress on AKS.</p>
<blockquote>
<p>Note: Be sure to use <code>letsencrypt-prod</code> - the Bot Emulator and Azure Bot Service will not work unless the bot is hosted under a trusted certificate.</p></blockquote>
<p>If you&rsquo;re following the anove walkthrough, you&rsquo;ll need to customise your http ingress routes.</p>
<p>Modify the K8s Ingress object to look something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot-ingress</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kubernetes.io/ingress.class</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">certmanager.k8s.io/cluster-issuer</span><span class="p">:</span><span class="w"> </span><span class="l">letsencrypt-prod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">tls</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">hosts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="l">my-dns-name.australiaeast.cloudapp.azure.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">tls-secret</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l">my-dns-name.australiaeast.cloudapp.azure.com</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">http</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">paths</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/bot</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l">my-bot-service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span></code></pre></div><p>That&rsquo;s it, you&rsquo;re done. You should be able to connect to your bot at <code>https://my-dns-name.australiaeast.cloudapp.azure.com/bot/api/messages</code></p>

<h2 class="relative group">Sample 
    <div id="sample" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#sample" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>You can see a full sample <a
  href="https://github.com/xtellurian/halp-bot"
    target="_blank"
  >on github</a></p>

<h2 class="relative group">Troubleshooting 
    <div id="troubleshooting" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#troubleshooting" aria-label="Anchor">#</a>
    </span>        
    
</h2>

<h3 class="relative group">The bot doesn&rsquo;t respond at all&hellip; 
    <div id="the-bot-doesnt-respond-at-all" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#the-bot-doesnt-respond-at-all" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Check the validity of the certificate by navigating to your https url in a browser. If the browser doesn&rsquo;t trust the certificate, your ingress isn&rsquo;t configured properly. Check the issuer of the certificate.</p>

<h3 class="relative group">The bot says I&rsquo;m unauthorized&hellip; 
    <div id="the-bot-says-im-unauthorized" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#the-bot-says-im-unauthorized" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>Check the values of MICROSOFT_APP_ID and MICROSOFT_APP_PASSWORD. They should be the same in the <a
  href="https://docs.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-connector-concepts?view=azure-bot-service-3.0#bot-connector-service"
    target="_blank"
  >Bot Service Connector</a> and in your code. The password is hidden inside a kubernetes secret.</p>

<h3 class="relative group">Something is wrong&hellip; 
    <div id="something-is-wrong" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100 select-none">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700 !no-underline" href="#something-is-wrong" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>You can get the logs from your container with the following command</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ kubectl logs --selector<span class="o">=</span><span class="nv">app</span><span class="o">=</span>my-bot
</span></span><span class="line"><span class="cl">restify listening to http://<span class="o">[</span>::<span class="o">]</span>:80
</span></span><span class="line"><span class="cl">Yes, this service is alive
</span></span><span class="line"><span class="cl">recieved a message
</span></span><span class="line"><span class="cl">Replying: <span class="o">[</span>conversationUpdate event detected<span class="o">]</span>
</span></span></code></pre></div>
  
  
  <div class="tags">
    <p>Tags: 
    
    <span class="tag">bots-in-kubernetes</span>
    
    </p>
  </div>
  
</article>

<nav class="post-nav">
  
  <a href="/posts/secret-to-event-processing/" class="next">← A secret to Event Processing</a>
  
  
  <a href="/posts/smarter-npcs-with-natural-language-processing/" class="prev">Smarter NPCs with Natural Language Processing →</a>
  
</nav>

  </main>
  
  <footer>
    <p>&copy; 2025 map[disableimageoptimization:false disableimageoptimizationmd:false disabletextinheader:false email:rian.finnegan@orkestra.energy fingerprintalgorithm:sha512 forgejodefaultserver:https://v11.next.forgejo.org giteadefaultserver:https://git.fsfe.org image:avatars/Rian_lookingaway2020.png name:Rian Finnegan]. All rights reserved.</p>
  </footer>
</body>
</html>
